<!DOCTYPE html>
<html>
<head>
    
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Fish classification using Keras &#8211; Page 42</title>
    <link rel="dns-prefetch" href="//maxcdn.bootstrapcdn.com">
    <link rel="dns-prefetch" href="//cdn.mathjax.org">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="A simple, beautiful theme for Jekyll that emphasizes content rather than aesthetic fluff.">
    <meta name="robots" content="all">
    <meta name="author" content="Abhinav Choudhury">
    
    <meta name="keywords" content="jekyll, update">
    <link rel="canonical" href="http://localhost:4000/jekyll/update/2017/04/15/fish-classification-keras/">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for Page 42" href="/feed.xml" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/pixyll.css?201704160125" type="text/css">

    <!-- Fonts -->
    
    <link href='//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Lato:900,300' rel='stylesheet' type='text/css'>
    
    
      <link href="//maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet">
    

    <!-- MathJax -->
    
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>
    

    <!-- Verifications -->
    
    

    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Fish classification using Keras">
    <meta property="og:description" content="A simple, beautiful theme for Jekyll that emphasizes content rather than aesthetic fluff.">
    <meta property="og:url" content="http://localhost:4000/jekyll/update/2017/04/15/fish-classification-keras/">
    <meta property="og:site_name" content="Page 42">
    

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    
    <meta name="twitter:title" content="Fish classification using Keras" />
    <meta name="twitter:description" content="A simple, beautiful theme for Jekyll that emphasizes content rather than aesthetic fluff." />
    <meta name="twitter:url" content="http://localhost:4000/jekyll/update/2017/04/15/fish-classification-keras/" />
    

    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">

    
</head>

<body class="site">
  
	

  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="http://localhost:4000" class="site-title">Page 42</a>
      <nav class="site-nav">
        
    

    
        <a href="/about/">About</a>
    

    

    

    

    

    

    

    

    


    

    

    

    

    

    

    

    

    

    


      </nav>
      <div class="clearfix"></div>
      
        <div class="social-icons">
  <div class="social-icons-right">
    
      <a class="fa fa-github" href="https://github.com/abhinavchdhry"></a>
    
    
    
    <a class="fa fa-rss" href="/feed.xml"></a>
    
    
    
    
    
      <a class="fa fa-envelope" href="mailto:achoudh3@ncsu.edu"></a>
    
    
    
    
    
    
  </div>
  <div class="right">
    
    
    
  </div>
</div>
<div class="clearfix"></div>

      
	
    </div>
  </div>
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
	


<div class="post-header mb2">
  <h1>Fish classification using Keras</h1>
  <span class="post-meta">Apr 15, 2017</span><br>
  
  <span class="post-meta small">
  
    2 minute read
  
  </span>
</div>

<article class="post-content">
  <p>Keras is a powerful framework for building deep learning models that facilitates rapid prototyping. It works on top of a tensor manipulation engine (either Tensorflow or Theano) which are optimized to leverage the GPU for fast, parallel matrix computations.</p>

<h3 id="data-organization-and-preprocessing">Data organization and preprocessing</h3>
<p>For an image classification task, you are likely to find your image dataset in a number of different formats:</p>
<ol>
  <li>A folder containing all the training images and a separate text file designating the class ids for each image</li>
  <li>Images named by concatenating their respective classes with an unique identifier eg. dog_001.jpg, cat_002.jpg, etc</li>
  <li>Separate directories for each class containing images of that class</li>
</ol>

<p>The image preprocessing library in Keras expects data to be in the third format. These inbuilt image reading and batching functionalities in Keras makes life a lot easier by allowing you to</p>

<h3 id="creating-training-and-validation-sets">Creating training and validation sets</h3>
<p>We need to split the data into a training set which will be used to train our deep learning model, and a validation set which would allow us to test how well our model classifies instances it has not seen before. This is a measure of the <strong>generalization capability</strong> of the model, and is crucial in reducing overfitting. The ratio of the split is usually set at 70:30 or 80:20.</p>

<p>The idea is to use a statistical sampling technique called the <strong>Stratified Split</strong>. If the dataset is split randomly and there are only a few of images for certain classes, it is likely that either the training set or the validation set will end up with no instances of those classes. When the model observes no instances of a certain class in its training data, its classification performance on instances of that class will likely be poor. Stratified split solves this problem by sampling instances from each class based on the set split ratio, thus ensuring both the training and validation sets have instances of every class.</p>

<p>Below is a function that uses Scikit-learnâ€™s <a href="http://scikit-learn.org/stable/modules/generated/sklearn.model_selection.StratifiedShuffleSplit.html">StratifiedShuffleSplit</a> function to create a 80:20 split</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">StratifiedShuffleSplit</span>

<span class="k">def</span> <span class="nf">stratifiedSplit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
        <span class="n">sss</span> <span class="o">=</span> <span class="n">StratifiedShuffleSplit</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">2017</span><span class="p">)</span>
        <span class="n">sss</span><span class="o">.</span><span class="n">get_n_splits</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span> <span class="ow">in</span> <span class="n">sss</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
                <span class="k">break</span>
        <span class="k">return</span><span class="p">(</span><span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span><span class="p">)</span>
</code></pre>
</div>

<p>Next, we use the function to create training and validation datasets:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code>
<span class="n">ORIGINAL_DATAPATH</span> <span class="o">=</span> <span class="s">"./train/"</span>
<span class="n">TRAIN_PATH</span> <span class="o">=</span> <span class="s">"./TRAIN/"</span>
<span class="n">VALIDATION_PATH</span> <span class="o">=</span> <span class="s">"./VALID/"</span>

<span class="k">def</span> <span class="nf">createTrainAndValidationDatasets</span><span class="p">(</span><span class="n">datapath</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"### Sampling training and validation datasets..."</span><span class="p">)</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="s">"ALB"</span><span class="p">,</span> <span class="s">"BET"</span><span class="p">,</span> <span class="s">"DOL"</span><span class="p">,</span> <span class="s">"LAG"</span><span class="p">,</span> <span class="s">"NoF"</span><span class="p">,</span> <span class="s">"OTHER"</span><span class="p">,</span> <span class="s">"SHARK"</span><span class="p">,</span> <span class="s">"YFT"</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">makeDirectoryStructure</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">cl</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">cl</span><span class="p">)</span>

        <span class="n">img_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">img_classes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
                <span class="n">class_dir</span> <span class="o">=</span> <span class="n">ORIGINAL_DATAPATH</span> <span class="o">+</span> <span class="n">cl</span> <span class="o">+</span> <span class="s">"/"</span>
                <span class="n">filepaths</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">class_dir</span> <span class="o">+</span> <span class="s">"*.jpg"</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="n">filepaths</span><span class="p">:</span>
                        <span class="n">img_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span>
                        <span class="n">img_classes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span>

        <span class="n">train_idx</span><span class="p">,</span> <span class="n">valid_idx</span> <span class="o">=</span> <span class="n">stratifiedSplit</span><span class="p">(</span><span class="n">img_names</span><span class="p">,</span> <span class="n">img_classes</span><span class="p">)</span>
        <span class="n">makeDirectoryStructure</span><span class="p">(</span><span class="n">TRAIN_PATH</span><span class="p">)</span>
        <span class="n">makeDirectoryStructure</span><span class="p">(</span><span class="n">VALIDATION_PATH</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">train_idx</span><span class="p">:</span>
                <span class="n">img_name</span> <span class="o">=</span> <span class="n">img_names</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">img_class</span> <span class="o">=</span> <span class="n">img_classes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">ORIGINAL_DATAPATH</span> <span class="o">+</span> <span class="n">img_class</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">img_name</span><span class="p">,</span>\
                	<span class="n">TRAIN_PATH</span> <span class="o">+</span> <span class="n">img_class</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">img_name</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">valid_idx</span><span class="p">:</span>
                <span class="n">img_name</span> <span class="o">=</span> <span class="n">img_names</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">img_class</span> <span class="o">=</span> <span class="n">img_classes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">ORIGINAL_DATAPATH</span> <span class="o">+</span> <span class="n">img_class</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">img_name</span><span class="p">,</span>
               		<span class="n">VALIDATION_PATH</span> <span class="o">+</span> <span class="n">img_class</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">img_name</span><span class="p">)</span>

<span class="n">createTrainAndValidationDatasets</span><span class="p">(</span><span class="n">ORIGINAL_DATAPATH</span><span class="p">)</span>
</code></pre>
</div>


</article>











      </div>
    </div>
  </div>

  <footer class="center">
  <div class="measure">
    <small>
	Page 42 is a blog about making machines learn.
    </small>
  </div>
</footer>


</body>
</html>
